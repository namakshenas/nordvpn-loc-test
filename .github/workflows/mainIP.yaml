name: CheckIPwithNordVPN

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:     # Manual trigger for testing

permissions:
  contents: write

jobs:
  check-ip:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install NordVPN
      run: |
        wget -qO - https://repo.nordvpn.com/gpg/nordvpn_public.asc | sudo tee /etc/apt/trusted.gpg.d/nordvpn_public.asc
        echo "deb https://repo.nordvpn.com/deb/nordvpn/debian stable main" | sudo tee /etc/apt/sources.list.d/nordvpn.list
        sudo apt update
        sudo apt install -y nordvpn
        
    - name: Connect to NordVPN
      env:
        NORDVPN_TOKEN: ${{ secrets.NORDVPN_TOKEN }}
      run: |
        # Login
        sudo nordvpn login --token $NORDVPN_TOKEN
        
        # Set protocol to UDP
        sudo nordvpn set protocol udp || true
        
        # Connect to fr1031
        echo "Connecting to server fr1031..."
        sudo nordvpn connect fr1031
        
        # Wait for connection
        sleep 10
        
        # Verify connection
        echo "=== VPN Status ==="
        sudo nordvpn status
        
    - name: Check IP and save
      run: |
        IP=$(curl -s https://checkip.amazonaws.com/)
        echo "$IP" > ip.txt
        echo "Current IP: $IP"
        
    - name: Commit IP file
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ip.txt
        git commit -m "Update IP - $(date)" || echo "No changes"
        git push || echo "No changes to push"
        
    - name: Disconnect VPN
      if: always()
      run: sudo nordvpn disconnect || true
      if: always()
      run: sudo nordvpn disconnect || true
